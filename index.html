<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èšé¤å°åŠ©æ‰‹</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .split-layout { display: flex; gap: 20px; }
        .left-panel { flex: 0 0 400px; min-width: 0; transition: all 0.3s ease; }
        .right-panel { flex: 1; min-width: 0; display: none; }
        .right-panel.active { display: block; }
        .right-panel-content { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; }
        @media (max-width: 900px) {
            .split-layout { flex-direction: column; }
            .left-panel { flex: none; width: 100%; }
            .left-panel.collapsed { display: none; }
            .right-panel { width: 100%; }
        }
        header { text-align: center; padding: 20px 0; }
        header h1 { font-size: 1.6rem; color: #333; }
        header p { color: #888; font-size: 0.9rem; margin-top: 4px; }
        .tabs { display: flex; margin-bottom: 20px; background: white; border-radius: 12px; padding: 4px; }
        .tab { flex: 1; padding: 12px; text-align: center; border-radius: 10px; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .tab:not(.active) { color: #666; }
        .tab:not(.active):hover { background: #f0f0f0; }
        .btn { display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-outline { background: white; color: #667eea; border: 1px solid #667eea; }
        .btn-outline:hover { background: #f8f9ff; box-shadow: none; transform: none; }
        .btn-small { padding: 8px 16px; font-size: 0.85rem; }
        .btn-block { width: 100%; }
        .card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); cursor: pointer; transition: box-shadow 0.2s; }
        .card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
        .card.active { box-shadow: 0 0 0 2px #667eea, 0 4px 16px rgba(0,0,0,0.08); }
        .card-has-images { background: linear-gradient(135deg, #f0f8ff 0%, #f5f0ff 100%); border-left: 3px solid #667eea; }
        .card h3 { font-size: 1.1rem; color: #333; margin-bottom: 8px; }
        .card-meta { font-size: 0.85rem; color: #888; display: flex; gap: 12px; flex-wrap: wrap; }
        .card-meta span { display: flex; align-items: center; gap: 4px; }
        .card-desc { font-size: 0.9rem; color: #666; margin: 8px 0; }
        .empty { text-align: center; padding: 60px 20px; color: #999; }
        .empty p { margin-bottom: 20px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 1.2rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: #555; font-weight: 500; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .detail-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-start; }
        .detail-header-content { flex: 1; }
        .detail-header h2 { font-size: 1.4rem; color: #333; margin-bottom: 8px; }
        .detail-meta { font-size: 0.85rem; color: #888; }
        .close-detail-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; padding: 0; line-height: 1; }
        .close-detail-btn:hover { color: #667eea; }
        .detail-desc { font-size: 1rem; color: #555; margin: 16px 0; padding: 12px; background: #f9f9f9; border-radius: 8px; }
        .back-btn { margin-bottom: 16px; color: #667eea; cursor: pointer; font-size: 0.9rem; }
        .back-btn:hover { text-decoration: underline; }
        .comments-section { margin-top: 24px; }
        .comments-section h3 { font-size: 1rem; color: #666; margin-bottom: 12px; }
        .comment { padding: 12px; background: #fafafa; border-radius: 8px; margin-bottom: 8px; }
        .comment-with-image { background: #f0f8ff; border-left: 3px solid #667eea; }
        .comment-header { font-size: 0.85rem; color: #888; margin-bottom: 6px; }
        .comment-content { font-size: 0.95rem; color: #333; }
        .comment-images { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .comment-images img { max-width: 150px; max-height: 150px; border-radius: 8px; cursor: pointer; object-fit: cover; border: 1px solid #eee; }
        .comment-images img:hover { opacity: 0.9; }
        .comment-form-wrapper { margin-top: 16px; background: #f9f9f9; border-radius: 12px; padding: 12px; }
        .comment-input-row { display: flex; gap: 8px; }
        .comment-input-row input { flex: 1; }
        .image-upload-area { margin-top: 10px; }
        .image-upload-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; background: white; border: 1px dashed #ccc; border-radius: 8px; cursor: pointer; font-size: 0.85rem; color: #666; transition: border-color 0.2s; }
        .image-upload-btn:hover { border-color: #667eea; color: #667eea; }
        .image-upload-btn input { display: none; }
        .image-preview-list { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .image-preview-item .remove-btn { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: #ff4d4f; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 1; display: flex; align-items: center; justify-content: center; }
        .upload-hint { font-size: 0.75rem; color: #999; margin-top: 6px; }
        .lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; cursor: pointer; }
        .lightbox.active { display: flex; }
        .lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .nickname-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .nickname-box { background: white; border-radius: 16px; padding: 32px; width: 90%; max-width: 360px; text-align: center; }
        .nickname-box h2 { margin-bottom: 8px; color: #333; }
        .nickname-box p { color: #888; font-size: 0.9rem; margin-bottom: 24px; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-header h2 { font-size: 1.1rem; color: #555; }
        .filter-toggle { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #888; cursor: pointer; user-select: none; }
        .filter-toggle input { cursor: pointer; }
        .placeholder-card { background: #f9f9f9; border: 2px dashed #ddd; text-align: center; padding: 30px; color: #999; }
        footer { text-align: center; padding: 20px; color: #bbb; font-size: 0.75rem; }
    </style>
</head>
<body>
    <div class="nickname-overlay" id="nickname-overlay">
        <div class="nickname-box">
            <h2>æ¬¢è¿ä½¿ç”¨èšé¤å°åŠ©æ‰‹</h2>
            <p>è¯·è¾“å…¥ä½ çš„ç§°å‘¼ï¼Œæ–¹ä¾¿ç¾¤å‹è®¤å‡ºä½ </p>
            <div class="form-group">
                <input type="text" id="nickname-input" placeholder="ä½ çš„æ˜µç§°" maxlength="20">
            </div>
            <button class="btn btn-block" onclick="saveNickname()">å¼€å§‹ä½¿ç”¨</button>
        </div>
    </div>
    <div class="lightbox" id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="" alt="é¢„è§ˆ">
    </div>
    <div class="container">
        <header>
            <h1>èšé¤å°åŠ©æ‰‹</h1>
            <p id="welcome-text"></p>
        </header>
        <div class="split-layout">
            <div class="left-panel" id="left-panel">
                <div class="tabs">
                    <div class="tab active" data-tab="places" onclick="switchTab('places')">æƒ³æ³•æ± </div>
                    <div class="tab" data-tab="events" onclick="switchTab('events')">èšé¤äº‹ä»¶</div>
                </div>
                <div id="places-section">
                    <div class="section-header">
                        <h2>å¤§å®¶çš„æƒ³æ³•</h2>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label class="filter-toggle">
                                <input type="checkbox" id="show-archive" onchange="loadPlaces()">
                                <span>æ˜¾ç¤ºç•™æ¡£</span>
                            </label>
                            <button class="btn btn-small btn-outline" onclick="randomPickPlace()">ğŸ² ä¸ºæˆ‘é€‰æ‹©</button>
                            <button class="btn btn-small" onclick="openCreatePlaceModal()">+ æ–°å»º</button>
                        </div>
                    </div>
                    <div id="places-list"><div class="loading">åŠ è½½ä¸­...</div></div>
                </div>
                <div id="events-section" style="display: none;">
                    <div class="section-header">
                        <h2>è¿‘æœŸèšé¤</h2>
                        <button class="btn btn-small btn-outline" onclick="openCreateEventModal()">+ å‘èµ·</button>
                    </div>
                    <div id="events-list">
                        <div class="placeholder-card">
                            <p>èšé¤äº‹ä»¶åŠŸèƒ½å¼€å‘ä¸­</p>
                            <p style="font-size: 0.85rem; margin-top: 8px;">æ•¬è¯·æœŸå¾…...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-panel" id="right-panel">
                <div class="right-panel-content">
                    <div id="detail-content"></div>
                </div>
            </div>
        </div>
        <footer>Created by MiniMax Agent</footer>
    </div>
    <div class="modal" id="create-place-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ–°å»ºæƒ³æ³•</h2>
                <button class="close-btn" onclick="closeCreatePlaceModal()">&times;</button>
            </div>
            <form id="create-place-form" onsubmit="createPlace(event)">
                <div class="form-group">
                    <label>æƒ³æ³• / åº—å *</label>
                    <input type="text" name="title" required placeholder="å¦‚ï¼šé™å®‰å¯ºé™„è¿‘çš„å¯¿å–œçƒ§">
                </div>
                <div class="form-group">
                    <label>ç®€å•æè¿°</label>
                    <textarea name="description" rows="2" placeholder="ä¸€å¥è¯è¯´æ˜ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                <button type="submit" class="btn btn-block">å‘å¸ƒæƒ³æ³•</button>
            </form>
        </div>
    </div>
    <script>
        const SUPABASE_URL = 'https://xciikonoumkqweemukec.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjaWlrb25vdW1rcXdlZW11a2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNTQ1MjEsImV4cCI6MjA4NjYzMDUyMX0.491qXqrO1H4RNu8LMA_iYtN8DTTKolj3w9VOpV8dIFI';
        const STORAGE_BUCKET = 'images';
        const MAX_IMAGE_SIZE = 2 * 1024 * 1024;
        const MAX_IMAGE_COUNT = 3;
        const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
        let pendingImages = [];

        async function supabaseFetch(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': options.prefer || 'return=representation' };
            const response = await fetch(url, { ...options, headers: { ...headers, ...options.headers } });
            if (!response.ok) { const error = await response.text(); throw new Error(error || response.statusText); }
            const text = await response.text();
            return text ? JSON.parse(text) : null;
        }

        async function uploadImage(file) {
            const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${file.name.split('.').pop()}`;
            const url = `${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}/${fileName}`;
            const response = await fetch(url, { method: 'POST', headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': file.type, 'x-upsert': 'true' }, body: file });
            if (!response.ok) { const error = await response.text(); throw new Error(error || 'ä¸Šä¼ å¤±è´¥'); }
            return `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${fileName}`;
        }

        function getNickname() { return localStorage.getItem('dinner_nickname'); }
        function saveNickname() {
            const input = document.getElementById('nickname-input');
            const nickname = input.value.trim();
            if (!nickname) { alert('è¯·è¾“å…¥æ˜µç§°'); return; }
            localStorage.setItem('dinner_nickname', nickname);
            document.getElementById('nickname-overlay').style.display = 'none';
            document.getElementById('welcome-text').textContent = `Hi, ${nickname}`;
            loadPlaces();
        }
        function checkNickname() {
            const nickname = getNickname();
            if (nickname) { document.getElementById('nickname-overlay').style.display = 'none'; document.getElementById('welcome-text').textContent = `Hi, ${nickname}`; return true; }
            return false;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById('places-section').style.display = tab === 'places' ? 'block' : 'none';
            document.getElementById('events-section').style.display = tab === 'events' ? 'block' : 'none';
        }

        async function loadPlaces() {
            const container = document.getElementById('places-list');
            const showArchive = document.getElementById('show-archive')?.checked || false;
            try {
                let places = await supabaseFetch('places?status=eq.active');
                if (!places || places.length === 0) { container.innerHTML = `<div class="empty"><p>è¿˜æ²¡æœ‰ä»»ä½•æƒ³æ³•</p><button class="btn" onclick="openCreatePlaceModal()">+ æ·»åŠ ç¬¬ä¸€ä¸ª</button></div>`; return; }
                // è¿‡æ»¤ç•™æ¡£å¸–å­ï¼ˆä»¥ [ç•™æ¡£] å¼€å¤´çš„æ ‡é¢˜ï¼‰
                if (!showArchive) {
                    places = places.filter(p => !p.title.startsWith('[ç•™æ¡£]'));
                }
                if (places.length === 0) { container.innerHTML = `<div class="empty"><p>æ²¡æœ‰å¯æ˜¾ç¤ºçš„æƒ³æ³•</p><p style="font-size: 0.85rem; color: #999; margin-top: 8px;">å‹¾é€‰"æ˜¾ç¤ºç•™æ¡£"å¯æŸ¥çœ‹ç•™æ¡£å¸–å­</p></div>`; return; }
                const placeIds = places.map(p => p.id);
                const comments = await supabaseFetch(`place_comments?place_id=in.(${placeIds.join(',')})`);
                const commentCounts = {};
                const latestCommentTime = {};
                const hasImageComment = {};
                (comments || []).forEach(c => {
                    commentCounts[c.place_id] = (commentCounts[c.place_id] || 0) + 1;
                    const t = new Date(c.created_at).getTime();
                    if (!latestCommentTime[c.place_id] || t > latestCommentTime[c.place_id]) {
                        latestCommentTime[c.place_id] = t;
                    }
                    if (c.image_urls && c.image_urls.length > 0) {
                        hasImageComment[c.place_id] = true;
                    }
                });
                // æŒ‰æœ€æ–°æ´»åŠ¨æ—¶é—´æ’åºï¼ˆæœ€æ–°è¯„è®ºæ—¶é—´ æˆ– åˆ›å»ºæ—¶é—´ï¼‰
                places.sort((a, b) => {
                    const aTime = latestCommentTime[a.id] || new Date(a.created_at).getTime();
                    const bTime = latestCommentTime[b.id] || new Date(b.created_at).getTime();
                    return bTime - aTime;
                });
                container.innerHTML = places.map(place => `<div class="card${hasImageComment[place.id] ? ' card-has-images' : ''}${currentPlaceId === place.id ? ' active' : ''}" data-id="${place.id}" onclick="openPlaceDetail('${place.id}')"><h3>${escapeHtml(place.title)}</h3>${place.description ? `<div class="card-desc">${escapeHtml(place.description)}</div>` : ''}<div class="card-meta"><span>${escapeHtml(place.created_by || 'åŒ¿å')}</span><span>${commentCounts[place.id] || 0} æ¡è¡¥å……</span><span>${formatDate(place.created_at)}</span></div></div>`).join('');
            } catch (err) { console.error('åŠ è½½å¤±è´¥:', err); container.innerHTML = `<div class="empty"><p>åŠ è½½å¤±è´¥: ${err.message}</p></div>`; }
        }

        async function createPlace(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = { title: formData.get('title'), description: formData.get('description') || null, created_by: getNickname(), status: 'active' };
            try {
                const result = await supabaseFetch('places', { method: 'POST', body: JSON.stringify(data) });
                closeCreatePlaceModal(); form.reset(); loadPlaces();
                if (result && result[0]) { openPlaceDetail(result[0].id); }
            } catch (err) { alert('å‘å¸ƒå¤±è´¥: ' + err.message); }
        }

        let currentPlaceId = null;
        async function openPlaceDetail(placeId) {
            currentPlaceId = placeId; pendingImages = [];
            // é«˜äº®é€‰ä¸­çš„å¡ç‰‡
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            const activeCard = document.querySelector(`.card[data-id="${placeId}"]`);
            if (activeCard) activeCard.classList.add('active');
            // æ˜¾ç¤ºå³ä¾§é¢æ¿
            document.getElementById('right-panel').classList.add('active');
            const container = document.getElementById('detail-content');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            try {
                const places = await supabaseFetch(`places?id=eq.${placeId}`);
                if (!places || places.length === 0) throw new Error('æœªæ‰¾åˆ°');
                const place = places[0];
                const comments = await supabaseFetch(`place_comments?place_id=eq.${placeId}&order=created_at.asc`);
                container.innerHTML = `<div class="detail-header"><div class="detail-header-content"><h2>${escapeHtml(place.title)}</h2><div class="detail-meta">ç”± ${escapeHtml(place.created_by || 'åŒ¿å')} åˆ›å»ºäº ${formatDate(place.created_at)}</div></div><button class="close-detail-btn" onclick="closeDetail()">&times;</button></div>${place.description ? `<div class="detail-desc">${escapeHtml(place.description)}</div>` : ''}<div class="comments-section"><h3>è¡¥å……ä¿¡æ¯ (${comments ? comments.length : 0})</h3><div id="comments-list">${comments && comments.length > 0 ? comments.map(c => `<div class="comment${c.image_urls && c.image_urls.length > 0 ? ' comment-with-image' : ''}"><div class="comment-header">${escapeHtml(c.created_by || 'åŒ¿å')} Â· ${formatDate(c.created_at)}</div><div class="comment-content">${escapeHtml(c.content)}</div>${renderCommentImages(c.image_urls)}</div>`).join('') : '<p style="color: #999; font-size: 0.9rem;">æš‚æ— è¡¥å……ï¼Œæ¥æ·»åŠ ç¬¬ä¸€æ¡å§</p>'}</div><div class="comment-form-wrapper"><div class="comment-input-row"><input type="text" id="comment-input" placeholder="æ·»åŠ è¡¥å……ä¿¡æ¯..." onpaste="handlePaste(event)"><button class="btn btn-small" id="send-btn" onclick="addComment()">å‘é€</button></div><div class="image-upload-area"><label class="image-upload-btn"><span>+ æ·»åŠ å›¾ç‰‡</span><input type="file" id="image-input" accept="image/jpeg,image/png,image/webp" multiple onchange="handleImageSelect(event)"></label><div class="upload-hint">æ”¯æŒ jpg/png/webp | Ctrl+V ç²˜è´´æˆªå›¾ | å•å¼  2MBï¼Œæœ€å¤š 3 å¼ </div><div class="image-preview-list" id="image-preview-list"></div></div></div></div>`;
            } catch (err) { container.innerHTML = `<div class="empty"><p>åŠ è½½å¤±è´¥: ${err.message}</p></div>`; }
        }

        function renderCommentImages(imageUrls) {
            if (!imageUrls || imageUrls.length === 0) return '';
            return `<div class="comment-images">${imageUrls.map(url => `<img src="${url}" alt="è¯„è®ºå›¾ç‰‡" onclick="openLightbox('${url}')">`).join('')}</div>`;
        }

        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            for (const file of files) {
                if (pendingImages.length >= MAX_IMAGE_COUNT) { alert(`æœ€å¤šä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`); break; }
                if (!ALLOWED_TYPES.includes(file.type)) { alert(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: ${file.name}\nä»…æ”¯æŒ jpg/png/webp`); continue; }
                if (file.size > MAX_IMAGE_SIZE) { alert(`å›¾ç‰‡å¤ªå¤§: ${file.name}\nå•å¼ å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 2MB`); continue; }
                pendingImages.push(file);
            }
            event.target.value = '';
            renderImagePreviews();
        }

        function renderImagePreviews() {
            const container = document.getElementById('image-preview-list');
            if (!container) return;
            container.innerHTML = pendingImages.map((file, index) => `<div class="image-preview-item"><img src="${URL.createObjectURL(file)}" alt="é¢„è§ˆ"><button class="remove-btn" onclick="removeImage(${index})">Ã—</button></div>`).join('');
        }

        function removeImage(index) { pendingImages.splice(index, 1); renderImagePreviews(); }

        function handlePaste(event) {
            const items = event.clipboardData?.items;
            if (!items) return;
            let hasImage = false;
            for (const item of items) {
                if (item.type.startsWith('image/')) {
                    hasImage = true;
                    const file = item.getAsFile();
                    if (!file) continue;
                    if (pendingImages.length >= MAX_IMAGE_COUNT) { alert(`æœ€å¤šä¸Šä¼  ${MAX_IMAGE_COUNT} å¼ å›¾ç‰‡`); break; }
                    if (!ALLOWED_TYPES.includes(file.type)) { alert(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼\nä»…æ”¯æŒ jpg/png/webp`); continue; }
                    if (file.size > MAX_IMAGE_SIZE) { alert(`å›¾ç‰‡å¤ªå¤§\nå•å¼ å›¾ç‰‡ä¸èƒ½è¶…è¿‡ 2MB`); continue; }
                    const namedFile = new File([file], `clipboard_${Date.now()}.png`, { type: file.type });
                    pendingImages.push(namedFile);
                }
            }
            if (hasImage) { event.preventDefault(); renderImagePreviews(); }
        }

        async function addComment() {
            const input = document.getElementById('comment-input');
            const sendBtn = document.getElementById('send-btn');
            const content = input.value.trim();
            if (!content && pendingImages.length === 0) { alert('è¯·è¾“å…¥å†…å®¹æˆ–æ·»åŠ å›¾ç‰‡'); return; }
            sendBtn.disabled = true; sendBtn.textContent = 'å‘é€ä¸­...';
            try {
                let imageUrls = [];
                if (pendingImages.length > 0) {
                    sendBtn.textContent = 'ä¸Šä¼ å›¾ç‰‡...';
                    for (const file of pendingImages) { const url = await uploadImage(file); imageUrls.push(url); }
                }
                await supabaseFetch('place_comments', { method: 'POST', body: JSON.stringify({ place_id: currentPlaceId, content: content || '(å›¾ç‰‡)', created_by: getNickname(), image_urls: imageUrls.length > 0 ? imageUrls : null }) });
                input.value = ''; pendingImages = []; openPlaceDetail(currentPlaceId);
            } catch (err) { alert('å‘é€å¤±è´¥: ' + err.message); sendBtn.disabled = false; sendBtn.textContent = 'å‘é€'; }
        }

        function closeDetail() {
            currentPlaceId = null;
            pendingImages = [];
            document.getElementById('right-panel').classList.remove('active');
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
        }

        function randomPickPlace() {
            const cards = document.querySelectorAll('#places-list .card[data-id]');
            if (cards.length === 0) { alert('å½“å‰æ²¡æœ‰å¯é€‰æ‹©çš„æƒ³æ³•'); return; }
            const randomIndex = Math.floor(Math.random() * cards.length);
            const randomCard = cards[randomIndex];
            const placeId = randomCard.getAttribute('data-id');
            openPlaceDetail(placeId);
        }

        function openLightbox(url) { document.getElementById('lightbox-img').src = url; document.getElementById('lightbox').classList.add('active'); }
        function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLightbox(); });

        function openCreatePlaceModal() { document.getElementById('create-place-modal').classList.add('active'); }
        function closeCreatePlaceModal() { document.getElementById('create-place-modal').classList.remove('active'); }
        function openCreateEventModal() { alert('èšé¤äº‹ä»¶åŠŸèƒ½å¼€å‘ä¸­...'); }
        document.querySelectorAll('.modal').forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); }); });

        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr); const now = new Date(); const diff = now - date;
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        if (checkNickname()) { loadPlaces(); }
    </script>
</body>
</html>