<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èšé¤å°åŠ©æ‰‹</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        header { text-align: center; padding: 20px 0 30px; }
        header h1 { font-size: 1.8rem; color: #333; }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }
        .event-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .event-card h3 { font-size: 1.2rem; color: #333; margin-bottom: 12px; }
        .event-info {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: #666;
        }
        .event-info span { display: flex; align-items: center; gap: 4px; }
        .event-note {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 12px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 6px;
        }
        .participants { font-size: 0.85rem; color: #667eea; margin-bottom: 12px; }
        .event-actions { display: flex; gap: 10px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: #555; }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 1.2rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state p { margin-bottom: 20px; }
        .loading { text-align: center; padding: 40px; color: #999; }
        .error { text-align: center; padding: 20px; color: #e74c3c; background: #fdf2f2; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; }
        footer { text-align: center; padding: 20px; color: #999; font-size: 0.8rem; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ½ï¸ èšé¤å°åŠ©æ‰‹</h1>
        </header>

        <div style="text-align: center; margin-bottom: 24px;">
            <button class="btn" onclick="openCreateModal()">+ å‘èµ·èšé¤</button>
        </div>

        <div id="events-list">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>

        <footer>Created by MiniMax Agent</footer>
    </div>

    <!-- åˆ›å»ºèšé¤å¼¹çª— -->
    <div class="modal" id="create-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å‘èµ·èšé¤</h2>
                <button class="close-btn" onclick="closeCreateModal()">&times;</button>
            </div>
            <form id="create-form" onsubmit="createEvent(event)">
                <div class="form-group">
                    <label>æ´»åŠ¨åç§° *</label>
                    <input type="text" name="title" required placeholder="å¦‚ï¼šå…ƒå®µèŠ‚ç«é”…">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æ—¥æœŸ</label>
                        <input type="text" name="date" placeholder="å¦‚ï¼š2/24">
                    </div>
                    <div class="form-group">
                        <label>æ—¶é—´</label>
                        <input type="text" name="time" placeholder="å¦‚ï¼šæ™šä¸Š7ç‚¹">
                    </div>
                </div>
                <div class="form-group">
                    <label>åœ°ç‚¹</label>
                    <input type="text" name="location" placeholder="å¦‚ï¼šé™å®‰å¤§æ‚¦åŸé™„è¿‘">
                </div>
                <div class="form-group">
                    <label>å‘èµ·äºº *</label>
                    <input type="text" name="organizer" required placeholder="ä½ çš„ç§°å‘¼">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea name="note" rows="2" placeholder="å…¶ä»–è¯´æ˜..."></textarea>
                </div>
                <button type="submit" class="btn" style="width: 100%;">å‘å¸ƒ</button>
            </form>
        </div>
    </div>

    <!-- åŠ å…¥èšé¤å¼¹çª— -->
    <div class="modal" id="join-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>åŠ å…¥èšé¤</h2>
                <button class="close-btn" onclick="closeJoinModal()">&times;</button>
            </div>
            <form id="join-form" onsubmit="joinEvent(event)">
                <input type="hidden" name="event-id" id="join-event-id">
                <div class="form-group">
                    <label>ä½ çš„ç§°å‘¼ *</label>
                    <input type="text" name="name" required placeholder="è¾“å…¥ä½ çš„åå­—">
                </div>
                <button type="submit" class="btn" style="width: 100%;">ç¡®è®¤åŠ å…¥</button>
            </form>
        </div>
    </div>

    <script>
        // Supabase REST API é…ç½®
        const SUPABASE_URL = 'https://xciikonoumkqweemukec.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjaWlrb25vdW1rcXdlZW11a2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNTQ1MjEsImV4cCI6MjA4NjYzMDUyMX0.491qXqrO1H4RNu8LMA_iYtN8DTTKolj3w9VOpV8dIFI';

        // é€šç”¨ fetch å‡½æ•°
        async function supabaseFetch(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1/${endpoint}`;
            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': options.prefer || 'return=representation'
            };

            const response = await fetch(url, {
                ...options,
                headers: { ...headers, ...options.headers }
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(error || response.statusText);
            }

            const text = await response.text();
            return text ? JSON.parse(text) : null;
        }

        // åŠ è½½æ´»åŠ¨åˆ—è¡¨
        async function loadEvents() {
            const container = document.getElementById('events-list');
            try {
                const data = await supabaseFetch('events?order=created_at.desc');

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <p>è¿˜æ²¡æœ‰èšé¤æ´»åŠ¨</p>
                            <p>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å‘èµ·ç¬¬ä¸€ä¸ªï¼</p>
                        </div>`;
                    return;
                }

                container.innerHTML = data.map(event => `
                    <div class="event-card">
                        <h3>${escapeHtml(event.title)}</h3>
                        <div class="event-info">
                            ${event.date ? `<span>ğŸ“… ${escapeHtml(event.date)}</span>` : ''}
                            ${event.time ? `<span>ğŸ• ${escapeHtml(event.time)}</span>` : ''}
                            ${event.location ? `<span>ğŸ“ ${escapeHtml(event.location)}</span>` : ''}
                            <span>ğŸ‘¤ ${escapeHtml(event.organizer)}</span>
                        </div>
                        ${event.note ? `<div class="event-note">${escapeHtml(event.note)}</div>` : ''}
                        <div class="participants">
                            ${event.participants && event.participants.length > 0
                                ? `å·²åŠ å…¥ï¼š${event.participants.map(p => escapeHtml(p)).join('ã€')}`
                                : 'æš‚æ— äººåŠ å…¥'}
                        </div>
                        <div class="event-actions">
                            <button class="btn btn-small" onclick="openJoinModal('${event.id}')">æˆ‘è¦åŠ å…¥</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥:', err);
                container.innerHTML = `<div class="error">âš ï¸ åŠ è½½å¤±è´¥: ${err.message}<br><small>è¯·æ£€æŸ¥ Supabase é…ç½®</small></div>`;
            }
        }

        // åˆ›å»ºæ´»åŠ¨
        async function createEvent(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const eventData = {
                title: formData.get('title'),
                date: formData.get('date') || null,
                time: formData.get('time') || null,
                location: formData.get('location') || null,
                organizer: formData.get('organizer'),
                note: formData.get('note') || null,
                participants: [formData.get('organizer')]
            };
            try {
                await supabaseFetch('events', {
                    method: 'POST',
                    body: JSON.stringify(eventData)
                });
                closeCreateModal();
                form.reset();
                loadEvents();
                alert('å‘å¸ƒæˆåŠŸï¼');
            } catch (err) {
                console.error('åˆ›å»ºå¤±è´¥:', err);
                alert('å‘å¸ƒå¤±è´¥: ' + err.message);
            }
        }

        // åŠ å…¥æ´»åŠ¨
        async function joinEvent(e) {
            e.preventDefault();
            const form = e.target;
            const eventId = document.getElementById('join-event-id').value;
            const name = form.querySelector('input[name="name"]').value;
            try {
                // è·å–å½“å‰å‚ä¸è€…
                const events = await supabaseFetch(`events?id=eq.${eventId}`);
                if (!events || events.length === 0) throw new Error('æ´»åŠ¨ä¸å­˜åœ¨');

                const event = events[0];
                const participants = event.participants || [];

                if (participants.includes(name)) {
                    alert('ä½ å·²ç»åŠ å…¥äº†ï¼');
                    return;
                }
                participants.push(name);

                // æ›´æ–°å‚ä¸è€…
                await supabaseFetch(`events?id=eq.${eventId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ participants })
                });

                closeJoinModal();
                form.reset();
                loadEvents();
                alert('åŠ å…¥æˆåŠŸï¼');
            } catch (err) {
                console.error('åŠ å…¥å¤±è´¥:', err);
                alert('åŠ å…¥å¤±è´¥: ' + err.message);
            }
        }

        // å¼¹çª—æ§åˆ¶
        function openCreateModal() { document.getElementById('create-modal').classList.add('active'); }
        function closeCreateModal() { document.getElementById('create-modal').classList.remove('active'); }
        function openJoinModal(eventId) {
            document.getElementById('join-event-id').value = eventId;
            document.getElementById('join-modal').classList.add('active');
        }
        function closeJoinModal() { document.getElementById('join-modal').classList.remove('active'); }

        // é˜² XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        });

        // åˆå§‹åŒ–
        loadEvents();
    </script>
</body>
</html>